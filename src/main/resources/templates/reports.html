<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<title>Student Reports | SRMS</title>

	<link rel="icon" type="image/png" href="/favicon.png">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
	<link rel="stylesheet" href="/css/klu-theme.css">
</head>

<body>

	<!-- HEADER -->
	<div th:replace="~{fragments/header :: header}"></div>

	<main class="content-wrapper">
		<div class="container mt-4">

			<!-- BREADCRUMB -->
			<nav aria-label="breadcrumb" class="mb-3">
				<ol class="breadcrumb">
					<li class="breadcrumb-item">
						<a th:href="@{/students}">
							<i class="bi bi-house-fill"></i> Home
						</a>
					</li>
					<li class="breadcrumb-item active">
						<i class="bi bi-bar-chart-fill"></i> Reports
					</li>
				</ol>
			</nav>

			<!-- PAGE TITLE -->
			<h2 class="page-title mb-3">
				<i class="bi bi-bar-chart-fill me-2"></i> Student Reports
			</h2>

			<!-- FILTER CARD -->
			<div class="card shadow-sm mb-4 border-0">
				<div class="card-body">
					<form method="post" th:action="@{/reports/search}" th:object="${filter}"
						class="row g-3 align-items-end">
						<!-- FILTER TYPE -->
						<div class="col-md-3">
							<label class="form-label">Filter By</label>
							<select id="filterType" name="filterType" class="form-select" onchange="onFilterChange()"
								required>
								<option value="">-- Select Filter --</option>
								<option value="id">Student ID</option>
								<option value="name">Student Name</option>
								<option value="program">Program</option>
								<option value="course">Course</option>
							</select>
						</div>

						<!-- DYNAMIC INPUTS -->
						<div class="col-md-7" id="dynamicInputs"></div>

						<!-- ACTION ICONS -->
						<div class="col-md-2 d-flex justify-content-end gap-2">

							<!-- SEARCH -->
							<button type="submit" class="btn btn-primary btn-sm px-3" title="Search">
								<i class="bi bi-search"></i>
							</button>

							<!-- EXCEL -->
							<a th:if="${showResults}" th:href="${queryString == null
        ? '/reports'
        : '/reports/download?' + queryString}" class="btn btn-success btn-sm px-3" title="Download Excel"
								target="_blank">
								<i class="bi bi-file-earmark-excel"></i>
							</a>

						</div>

					</form>
				</div>
			</div>

			<!-- RESULTS TABLE -->
			<div class="table-wrapper" th:if="${showResults}">
				<table class="table table-hover align-middle mb-0">
					<thead>
						<tr>
							<th>ID</th>
							<th>Name</th>
							<th>Program</th>
							<th>Course</th>
							<th>Year of Admission</th>
							<th>Date of Birth</th>
						</tr>
					</thead>

					<tbody>
						<tr th:each="s : ${students}">
							<td th:text="${s.id}"></td>
							<td th:text="${s.name}"></td>
							<td th:text="${s.programType}"></td>
							<td th:text="${s.course}"></td>
							<td th:text="${s.yearOfAdmission}"></td>
							<td th:text="${#temporals.format(s.dateOfBirth,'dd-MM-yyyy')}"></td>
							<td>
								<a th:href="@{/students/{id}/performance(id=${s.id})}"
									class="btn btn-outline-primary btn-sm" title="View Performance">
									<i class="bi bi-graph-up"></i>
								</a>
							</td>

						</tr>

						<!-- EMPTY STATE (ONLY AFTER SEARCH) -->
						<tr th:if="${param.filterType != null and #lists.isEmpty(students)}">
							<td colspan="7" class="text-center text-muted py-4">
								<i class="bi bi-info-circle me-1"></i>
								No records found
							</td>
						</tr>

					</tbody>
				</table>
			</div>

		</div>
	</main>
	<div th:replace="fragments/footer :: footer"></div>


	<!-- ================= JS ================= -->
	<script>
		function onFilterChange() {
			const type = document.getElementById("filterType").value;
			const c = document.getElementById("dynamicInputs");
			c.innerHTML = "";

			const p = new URLSearchParams(window.location.search);

			const input = (label, name) => `
            <label class="form-label">${label}</label>
            <input class="form-control"
                   name="${name}"
                   value="${p.get(name) || ''}">
        `;

			if (type === "id") c.innerHTML = input("Student ID", "id");
			if (type === "name") c.innerHTML = input("Student Name", "name");
			if (type === "course") c.innerHTML = input("Course", "course");

			if (type === "program") {
				c.innerHTML = `
                <label class="form-label">Program</label>
                <select name="programType" class="form-select">
                    <option value="">Select</option>
                    <option value="B.Tech">B.Tech</option>
                    <option value="M.Tech">M.Tech</option>
                </select>`;
			}

			if (type === "year") {
				c.innerHTML = `
                <div class="row">
                    <div class="col">
                        <label class="form-label">From Year</label>
                        <input class="form-control" name="yearFrom"
                               value="${p.get("yearFrom") || ''}">
                    </div>
                    <div class="col">
                        <label class="form-label">To Year</label>
                        <input class="form-control" name="yearTo"
                               value="${p.get("yearTo") || ''}">
                    </div>
                </div>`;
			}

			if (type === "cgpa") {
				c.innerHTML = `
                <div class="row">
                    <div class="col">
                        <label class="form-label">Min CGPA</label>
                        <input class="form-control" name="cgpaMin"
                               value="${p.get("cgpaMin") || ''}">
                    </div>
                    <div class="col">
                        <label class="form-label">Max CGPA</label>
                        <input class="form-control" name="cgpaMax"
                               value="${p.get("cgpaMax") || ''}">
                    </div>
                </div>`;
			}
		}

		document.addEventListener("DOMContentLoaded", onFilterChange);
	</script>

</body>

</html>